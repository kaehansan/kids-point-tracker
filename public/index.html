<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minute Tracker v6.1</title>
    <style>
        :root { --bg-start: #667eea; --bg-end: #764ba2; --kid-red: #FF6B6B; --kid-teal: #4ECDC4; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #F0F8FF; display: flex; flex-direction: column; height: 100vh; }
        
        .header { background: linear-gradient(to right, var(--bg-start), var(--bg-end)); padding: 20px; color: white; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 300px; }
        
        .tabs { display: flex; background: white; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #888; cursor: pointer; font-weight: bold; }
        .tab.active { color: var(--bg-start); border-bottom: 3px solid var(--bg-start); background: #F8F9FF; }

        .kid-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 3px solid transparent; transition: all 0.2s; }
        .kid-card.selected { border-color: var(--bg-start); background-color: #F0F2FF; transform: scale(1.02); }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: #FFEBEE; color: var(--kid-red); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-weight: bold; }
        .kid-name-input { font-size: 24px; font-weight: 800; text-align: center; border: none; background: transparent; width: 80%; outline: none; margin-bottom: 5px; color: #333; }
        .kid-minutes { font-size: 40px; font-weight: 900; letter-spacing: -1px; }

        .controls { background: white; padding: 20px; border-top-left-radius: 30px; border-top-right-radius: 30px; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); position: fixed; bottom: 0; width: 100%; box-sizing: border-box; z-index: 100; max-height: 55vh; overflow-y: auto; }
        
        .tags-wrapper { overflow-x: auto; white-space: nowrap; margin-bottom: 15px; padding-bottom: 5px; }
        .tag-btn { position: relative; display: inline-flex; align-items: center; padding: 10px 18px; margin-right: 8px; border-radius: 12px; border: 2px solid #eee; cursor: pointer; font-weight: bold; font-size: 14px; background: white; color: #444; transition: all 0.2s; user-select: none; }
        .tag-btn.selected { background: #9B59B6; color: white; border-color: #9B59B6; box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4); }
        .tag-btn.add { background: #f0f0f0; border: 1px dashed #aaa; }
        .tag-delete { margin-left: 8px; width: 22px; height: 22px; background: rgba(0,0,0,0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; color: #555; cursor: pointer; }

        .presets-header { font-size: 12px; color: #888; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .presets-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .preset-box { display: flex; flex-direction: column; }
        .preset-input { width: 100%; text-align: center; border: 1px solid #ddd; border-top-left-radius: 10px; border-top-right-radius: 10px; padding: 8px 0; font-size: 16px; font-weight: bold; box-sizing: border-box; background: #FAFAFA; }
        .preset-btn { width: 100%; padding: 10px 0; background: var(--bg-start); color: white; border: none; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; }
        
        .manual-section { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; background: #F8F9FA; padding: 10px; border-radius: 15px; }
        .manual-input { width: 60px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; text-align: center; font-size: 18px; font-weight: bold; }
        .action-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; color: white; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px; background: var(--kid-red); }
        
        .date-header { font-weight: 800; color: #888; margin: 25px 0 10px 5px; font-size: 16px; }
        .history-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 12px; border-left: 5px solid var(--bg-start); font-size: 15px; color: #444; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .history-time { font-size: 12px; color: #aaa; background: #f5f5f5; padding: 4px 8px; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="app-container" style="display:flex; height: 100%; flex-direction: column;">
        <div class="header">
            <h2 style="margin:0;">Minute Tracker v6.1</h2>
            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                <span id="total-label">Family Total:</span> 
                <span id="daily-val" style="font-weight:bold;">0m</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('daily')" id="tab-daily">Tracker</div>
            <div class="tab" onclick="switchTab('weekly')" id="tab-weekly">Weekly Log</div>
        </div>

        <div id="view-daily" class="content-area">
            <div id="kids-container"></div>
            <button onclick="addKid()" style="width:100%; padding:15px; background:#f0f0f0; color:#666; border:2px dashed #ccc; border-radius:15px; font-weight:bold; font-size: 16px; margin-top:10px;">+ Add Another Kid</button>
        </div>

        <div id="view-weekly" class="content-area" style="display:none;">
            <div style="background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; text-align: center;">
                <div style="color: #888; font-size: 14px;" id="weekly-label">Family Balance</div>
                <div style="font-size: 48px; font-weight:900; color:#FDCB6E;"><span id="weekly-total-display">0m</span></div>
            </div>
            <div id="history-log"></div>
        </div>

        <div class="controls" id="controls-panel">
            <div style="text-align: center; color: #888; font-weight: bold; margin-bottom: 10px; font-size: 14px;" id="selected-status">Tap a kid above to start</div>
            
            <div class="tags-wrapper" id="tags-container"></div>
            <div class="presets-header">Quick Add (Edit numbers below)</div>
            <div class="presets-grid" id="presets-container"></div>

            <div class="manual-section">
                <span>Custom:</span>
                <button class="stepper-btn" onclick="adjustManual(-1)">-</button>
                <input type="number" id="manual-input" class="manual-input" value="1">
                <button class="stepper-btn" onclick="adjustManual(1)">+</button>
            </div>
            
            <button class="action-btn" onclick="applyManual(true)" style="background: var(--kid-teal); margin-bottom: 8px;">+ Add Points</button>
            <button class="action-btn" onclick="applyManual(false)">- Remove Points</button>
        </div>
    </div>

    <script>
        let kids = []; 
        let historyData = []; // Store raw history
        let selectedKidId = -1; 
        let currentTag = "General"; 
        let presets = [];

        window.onload = loadData;
        
        async function loadData() { 
            const res = await fetch('/api/data'); 
            const data = await res.json(); 
            kids = data.kids; 
            historyData = data.history; // Save raw history
            presets = data.presets;
            
            // Initial Render
            updateTotals(); 
            renderKids(); 
            renderTags(data.tags); 
            renderHistory(); 
            renderPresets();
        }

        // --- NEW: Helper to calculate & display totals based on selection ---
        function updateTotals() {
            let displayTotal = 0;
            let labelText = "Family Total:";
            let weeklyLabel = "Family Balance";

            // If a kid is selected, only show their points
            if (selectedKidId !== -1) {
                const kid = kids.find(k => k.id === selectedKidId);
                if (kid) {
                    displayTotal = kid.minutes;
                    labelText = `${kid.name}'s Total:`;
                    weeklyLabel = `${kid.name}'s Balance`;
                }
            } else {
                // If no kid selected, sum everyone
                kids.forEach(k => displayTotal += k.minutes);
            }

            // Update Header
            document.getElementById('total-label').innerText = labelText;
            document.getElementById('daily-val').innerText = formatTime(displayTotal);
            
            // Update Weekly Tab Big Number
            document.getElementById('weekly-label').innerText = weeklyLabel;
            document.getElementById('weekly-total-display').innerText = formatTime(displayTotal);
        }

        function formatTime(minutes) {
            const h = Math.floor(Math.abs(minutes) / 60);
            const m = Math.abs(minutes) % 60;
            const sign = minutes < 0 ? "-" : "";
            if (h > 0) return `${sign}${h}h ${m}m`;
            return `${sign}${m}m`;
        }
        
        function renderKids() {
            const container = document.getElementById('kids-container'); 
            container.innerHTML = ''; 
            
            kids.forEach(kid => {
                const card = document.createElement('div');
                card.className = `kid-card ${kid.id === selectedKidId ? 'selected' : ''}`;
                
                // CLICK HANDLER: Selects Kid AND updates totals/history
                card.onclick = (e) => { 
                    if(['INPUT', 'BUTTON', 'SPAN'].includes(e.target.tagName) || e.target.classList.contains('delete-btn')) return; 
                    
                    // Toggle selection (Click again to deselect)
                    if (selectedKidId === kid.id) {
                        selectedKidId = -1; // Deselect
                        document.getElementById('selected-status').innerText = "Tap a kid above to start";
                        document.getElementById('selected-status').style.color = "#888";
                    } else {
                        selectedKidId = kid.id; // Select
                        document.getElementById('selected-status').innerText = `Selected: ${kid.name}`; 
                        document.getElementById('selected-status').style.color = kid.color; 
                    }
                    
                    renderKids(); 
                    updateTotals(); // Refresh header numbers
                    renderHistory(); // Refresh list to show only this kid
                };
                
                card.innerHTML = `
                    <button class="delete-btn" onclick="removeKid(${kid.id})">âœ•</button>
                    <input class="kid-name-input" value="${kid.name}" onchange="updateName(${kid.id}, this.value)">
                    <div class="kid-minutes" style="color: ${kid.color}">${formatTime(kid.minutes)}</div>
                `;
                container.appendChild(card);
            });
        }

        function renderHistory() {
            const container = document.getElementById('history-log'); 
            container.innerHTML = '';
            
            // FILTER: If a kid is selected, only show entries that start with their name
            let filteredHistory = historyData;
            if (selectedKidId !== -1) {
                const kid = kids.find(k => k.id === selectedKidId);
                if (kid) {
                    filteredHistory = historyData.filter(entry => entry.text.startsWith(kid.name));
                }
            }

            let lastDate = "";
            const now = new Date();
            const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);

            filteredHistory.forEach(entry => {
                const dateObj = new Date(entry.timestamp);
                let dateStr = dateObj.toDateString();
                if (dateStr === now.toDateString()) dateStr = "Today";
                else if (dateStr === yesterday