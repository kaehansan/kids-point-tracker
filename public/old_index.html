<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minute Tracker</title>
    <style>
        :root {
            --bg-start: #667eea;
            --bg-end: #764ba2;
            --kid-red: #FF6B6B;
            --kid-teal: #4ECDC4;
        }
        body { margin: 0; font-family: sans-serif; background-color: #F0F8FF; display: flex; flex-direction: column; height: 100vh; }
        
        /* Login Overlay */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom right, var(--bg-start), var(--bg-end)); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 2rem; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        input { padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; width: 90%; font-size: 16px; }
        
        /* Main App */
        .header { background: linear-gradient(to right, var(--bg-start), var(--bg-end)); padding: 20px; color: white; }
        .tabs { display: flex; background: rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px; text-align: center; color: white; cursor: pointer; font-weight: bold; opacity: 0.6; }
        .tab.active { opacity: 1; border-bottom: 3px solid white; }
        
        /* Kid List */
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .kid-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent; transition: all 0.2s; }
        .kid-card.selected { border-color: var(--bg-start); background-color: #E6E6FA; transform: scale(1.02); }
        
        .delete-btn { position: absolute; top: 10px; right: 10px; background: var(--kid-red); color: white; border: none; border-radius: 5px; cursor: pointer; padding: 5px 10px; }
        
        .kid-name-input { font-size: 24px; font-weight: bold; text-align: center; border: none; background: transparent; width: 100%; outline: none; margin-bottom: 10px; }
        .kid-minutes { font-size: 32px; font-weight: bold; }
        
        /* Control Panel */
        .controls { background: white; padding: 20px; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        
        .tags-wrapper { overflow-x: auto; white-space: nowrap; margin-bottom: 15px; padding-bottom: 5px; }
        .tag-btn { display: inline-block; padding: 10px 20px; margin-right: 8px; border-radius: 8px; border: none; cursor: pointer; color: white; font-weight: bold; }
        .tag-btn.add { background: #E0E0E0; color: #555; }
        
        .time-buttons { display: flex; gap: 10px; }
        .time-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        
        /* History View */
        #view-weekly { display: none; padding: 20px; }
        .history-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid var(--bg-start); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>üîê Login</h2>
            <input type="password" id="password" placeholder="Password">
            <button class="time-btn" style="background: var(--kid-teal); width: 100%;" onclick="login()">Enter</button>
        </div>
    </div>

    <div id="app-container" style="display:none; height: 100%; flex-direction: column;">
        <div class="header">
            <h2>‚≠ê Minute Tracker</h2>
            <div id="daily-tally">Today's Total: <span id="daily-val">0</span>m</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('daily')" id="tab-daily">Daily Tracker</div>
            <div class="tab" onclick="switchTab('weekly')" id="tab-weekly">Weekly History</div>
        </div>

        <div id="view-daily" class="content-area">
            <div id="kids-container">
                </div>
            <button onclick="addKid()" style="width:100%; padding:10px; background:#888; color:white; border:none; border-radius:8px;">+ Add Another Kid</button>
        </div>

        <div id="view-weekly" class="content-area">
            <h3>Weekly Summary</h3>
            <div style="font-size: 24px; font-weight:bold; color:gold; margin-bottom: 20px;">
                Total: <span id="weekly-total-display">0</span>m
            </div>
            <div id="history-log">
                </div>
        </div>

        <div class="controls" id="controls-panel">
            <div style="text-align: center; color: #555; font-weight: bold; margin-bottom: 10px;" id="selected-status">Tap a kid above to start</div>
            
            <div class="tags-wrapper" id="tags-container">
                </div>

            <div class="time-buttons">
                <button class="time-btn" style="background: var(--kid-red)" onclick="addTime(-5)">- Remove</button>
                <button class="time-btn" style="background: #667eea" onclick="addTime(5)">+5m</button>
                <button class="time-btn" style="background: #764ba2" onclick="addTime(15)">+15m</button>
                <button class="time-btn" style="background: var(--kid-teal)" onclick="addTime(30)">+30m</button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let kids = [];
        let selectedKidId = -1;
        let currentTag = "General";
        let history = [];

        // --- AUTH ---
        function login() {
            if(document.getElementById('password').value) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                loadData(); // Fetch data from server
            }
        }

        // --- DATA LOADING ---
        async function loadData() {
            const res = await fetch('/api/data');
            const data = await res.json();
            
            kids = data.kids;
            history = data.history;
            document.getElementById('weekly-total-display').innerText = data.weekly_total;
            
            renderKids();
            renderTags(data.tags);
            renderHistory();
        }

        // --- UI RENDERING ---
        function renderKids() {
            const container = document.getElementById('kids-container');
            container.innerHTML = '';
            let dailyTotal = 0;

            kids.forEach(kid => {
                dailyTotal += kid.minutes;
                const card = document.createElement('div');
                card.className = `kid-card ${kid.id === selectedKidId ? 'selected' : ''}`;
                card.onclick = (e) => {
                    if(e.target.tagName === 'INPUT' || e.target.className === 'delete-btn') return;
                    selectedKidId = kid.id;
                    document.getElementById('selected-status').innerText = `Selected: ${kid.name}`;
                    document.getElementById('selected-status').style.color = kid.color;
                    renderKids();
                };

                card.innerHTML = `
                    <button class="delete-btn" onclick="removeKid(${kid.id})">‚úï</button>
                    <input class="kid-name-input" value="${kid.name}" onchange="updateName(${kid.id}, this.value)">
                    <div class="kid-minutes" style="color: ${kid.color}">${kid.minutes} min</div>
                `;
                container.appendChild(card);
            });
            document.getElementById('daily-val').innerText = dailyTotal;
        }

        function renderTags(tags) {
            const container = document.getElementById('tags-container');
            container.innerHTML = '';
            tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'tag-btn';
                btn.style.background = '#9B59B6';
                btn.innerText = tag;
                btn.onclick = () => { currentTag = tag; alert(`Activity: ${tag}`); };
                container.appendChild(btn);
            });
            
            // Add "+" Button
            const addBtn = document.createElement('button');
            addBtn.className = 'tag-btn add';
            addBtn.innerText = '+';
            addBtn.onclick = addNewTag;
            container.appendChild(addBtn);
        }

        function renderHistory() {
            const container = document.getElementById('history-log');
            container.innerHTML = '';
            history.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerText = entry;
                container.appendChild(div);
            });
        }

        // --- ACTIONS ---
        function switchTab(tab) {
            document.getElementById('view-daily').style.display = tab === 'daily' ? 'block' : 'none';
            document.getElementById('view-weekly').style.display = tab === 'weekly' ? 'block' : 'none';
            document.getElementById('controls-panel').style.display = tab === 'daily' ? 'block' : 'none';
            document.getElementById('tab-daily').classList.toggle('active', tab === 'daily');
            document.getElementById('tab-weekly').classList.toggle('active', tab === 'weekly');
        }

        async function addKid() {
            await fetch('/api/add_kid', {method: 'POST'});
            loadData();
        }

        async function removeKid(id) {
            if(!confirm('Remove this kid?')) return;
            await fetch(`/api/remove_kid/${id}`, {method: 'POST'});
            loadData();
        }

        async function updateName(id, newName) {
            await fetch(`/api/update_name/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: newName})
            });
        }

        async function addNewTag() {
            const tag = prompt("New Activity Name:");
            if(tag) {
                await fetch('/api/add_tag', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tag: tag})
                });
                loadData();
            }
        }

        async function addTime(minutes) {
            if(selectedKidId === -1) { alert("Select a kid first!"); return; }
            
            const res = await fetch('/api/add_time', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({kid_id: selectedKidId, minutes: minutes, tag: currentTag})
            });
            const data = await res.json();
            
            if(data.success) {
                loadData();
            }
        }
    </script>
</body>
</html>